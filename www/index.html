<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>EnergyWare - Main</title>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width" />
        <link rel="stylesheet" href="res/jquery-mobile.min.css" />
        <link rel="stylesheet" href="res/style.css" />
        <link rel="stylesheet" href="res/utils.css" />

        <!--Cordova library and plugins-->
        <script type="text/javascript" src="cordova.js"></script>
        
        <!--Another libraries-->
        <script type="text/javascript" src="libs/js/jquery.min.js"></script>
        <script type="text/javascript" src="libs/js/jquery-mobile.min.js"></script>
        <script type="text/javascript" src="libs/js/highcharts.js"></script>
        <script type="text/javascript" src="libs/js/highcharts-more.js"></script>
        <script type="text/javascript" src="libs/js/projectbase.js"></script>
        
        <!--Main code-->
        <script type="text/javascript">
            var LinkServer = null, _machine = 0, _status = {
                1: 'active',
                2: 'suspended',
                3: 'inactive'
            };
            
            var Pages = {
                relations: function () {
                    $.mobile.changePage('#relations');
                    Machine.load();
                },
                machine: function () {
                    $.mobile.changePage('#dialog-filter');
                    Machine.load();
                }
            };
            
            var Machine = {
                load: function () {
                    uget({
                        url: LinkServer.Url('machine', 'get', {
                            uuid: device.uuid
                        })
                    }).done(function (data) {
                        if(data._code === 200) {
                            $("#list-machine").html("<legend>Equipos relacionados:</legend>");
                            $("#current-machine").html("<legend>Seleccione un equipo:</legend>");
                            for(var i=0; i<data._response.length; i++) {
                                var ob = data._response[i];
                                
                                $("#list-machine").append(
                                    "<label for='" + ob.idmachine + "-1'>" + ob.user + "</label><input type='checkbox' name='machine' id='" + ob.idmachine + "-1' value='" + ob.idmachine + "'>"
                                );
                        
                                $("#current-machine").append(
                                    "<label for='" + ob.idmachine + "-2'>" + ob.user + "</label><input type='checkbox' name='machine' id='" + ob.idmachine + "-2' value='" + ob.idmachine + "'>"
                                );
                            }
                            
                            $("#current-machine").trigger("create");
                            $("#list-machine").trigger("create");
                        }
                    });
                },
                relation: function (machine) {
                    uget({
                        url: LinkServer.Url('machine', 'add_relation'),
                        type: 'POST',
                        data: {
                            uuid: device.uuid,
                            machine: machine
                        }
                    }).done(function (data) {
                        if(data._code === 200) {
                            Machine.load();
                        } else {
                            navigator.notification.alert(data._message, 'Error', 'Done');
                        }
                    });
                },
                change: function (id) {
                    navigator.notification.alert(id, 'Error', 'Done');
                    _machine = id;
                }
            };
            
            var History = {
                load: function () {
                    uget({
                        url: LinkServer.Url('history', 'get', {
                            machine     : _machine,
                            uuid        : device.uuid
                        })
                    }).done(function (data) {
                        if(data._code === 200) {
                            if(data._response.length > 0) {
                                var ob = data._response[0],
                                    date = ob.date.split(' ');
                                
                                $("#cpu-usage").val(ob.cpu);
                                $("#ram-usage").val(ob.ram);
                                $("#download-speed").html(ob.download + "Kbps");
                                $("#upload-speed").html(ob.upload + "Kbps");
                                $("#pc-status").html(_status[ob.status]);
                                $("#date-refresh").html(date[0]);
                                $("#hour-refresh").html(date[1]);
                            }
                        }

                        setTimeout(function () {
                            History.load();
                        }, 10000);
                    });
                }
            };
            
            $(function () {
                //Initialize variables
                LinkServer = new Linker('http://192.227.159.91/energy/');
                LinkServer.setExtension(".json?");
                
                //Remove transitions
                $(document).bind('pageinit', function () {
                    $.mobile.defaultPageTransition = 'none';
                });
                
                $("#frm-relations").submit(function (e) {
                    e.preventDefault();
                    Machine.relation($("#idmachine").val());
                });
                
                $("#frm-current-machine").submit(function (e) {
                    e.preventDefault();
                    Machine.change($(this).find("input [name=machine]").val());
                });
                
                //Autenticate user
                uget({
                    url: LinkServer.Url('user', 'update', []),
                    type: 'POST',
                    data: {
                        uuid     : device.uuid,
                        platform : device.platform,
                        model    : device.model,
                        version  : device.version
                    }
                }).done(function (data) {
                    if(data._code === 200) {
                        History.load();
                    }
                });
            });
            
            

            // Transaction error callback
            function error(err) {
                console.log(err.message);
            }

            // Transaction success callback
            function success() {}

            function initialize() {
                //generatePol();
            }
        </script>
    </head>
    <body>
        <div data-role="page" id="pageone">
            <div data-role="header" data-position="fixed">
                <a href="#" onclick="javascript: Pages.machine();" data-rel="popup" data-position-to="window" data-iconpos="notext" data-role="button" data-icon="bars">Equipos</a>
                <h1>EnergyWare</h1>
                <a href="#configurations" data-iconpos="notext" data-role="button" data-icon="calendar">Opciones</a>
            </div>

            <div data-role="content">
                <h2 class="no-margin-center">
                    <span id="machine-name">Nombre Equipo</span>
                </h2>
                
                <h3 class="no-margin-center">
                    <span id="hour-refresh">09:12:08</span>
                </h3>
                <h4 class="no-margin-center">
                    <i class="utils-calendar"></i>
                    <span id="date-refresh">2014-04-12</span>
                </h4>
                
                <div class="full-width-slider">
                    <label class="subtitle"><i class="utils-stats"></i> CPU:</label>
                    <input type="range" id="cpu-usage" data-highlight="true" min="0" max="100" value="22">
                </div>
                
                <div class="full-width-slider">
                    <label class="subtitle"><i class="utils-stats"></i> RAM:</label>
                    <input type="range" id="ram-usage" data-highlight="true" min="0" max="100" value="50">
                </div>
                
                <p class="subtitle"><i class="utils-stats"></i> Tráfico de Red:</p>
                <p class="letitbigger">
                    <span class="half">
                        <i class="utils-download"></i> <b id="download-speed">420Kbps</b>
                    </span>
                    <span class="half">
                        <i class="utils-upload"></i> <b id="upload-speed">60Kbps</b>
                    </span>
                </p>
                
                <div style="clear: both"></div>
                
                <p class="subtitle"><i class="utils-info"></i> Estado: <span id="pc-status">online</span></p>
            </div>
            
            <div data-role="footer" data-theme="b" data-position="fixed">
                <fieldset class="full subbuttons" data-role="controlgroup" data-type="horizontal">
                    <button onclick="javascript: Pages.relations();" data-icon="eye">Rel.</button>
                    <button data-icon="recycle">Suspend</button>
                    <button data-icon="power">Power Off</button>
                </fieldset>
            </div>
            
            
            
            <div data-role="popup" id="dialog-filter">
                <div data-role="header">
                    <h1>Seleccione...</h1>
                </div>
                
                <form method="post" id="frm-current-machine">
                    <div data-role="main" class="ui-content">
                        <fieldset data-role="controlgroup" id="current-machine"></fieldset>
                    </div>
                    
                    <div data-role="footer" data-theme="b">
                        <div align="right" style="margin: 0 5px;">
                            <button data-icon="check" >Aceptar</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        
        
        
        <div data-role="page" id="relations">
            <div data-role="header" data-position="fixed">
                <a href="#" data-rel="back" data-iconpos="notext" data-role="button" data-icon="arrow-l">Regresar</a>
                <h1>Relaciones</h1>
            </div>

            <div data-role="content">
                <form class="overflow" id="frm-relations">
                    <div class="half">
                        <input placeholder="Código" id="idmachine" type="text" name="code" />
                    </div>

                    <div class="half">
                        <button style="float: right;" class="ui-btn ui-icon-plus ui-btn-icon-notext">Agregar</button>
                    </div>
                </form>
                
                <fieldset data-role="controlgroup" id="list-machine"></fieldset>
            </div>
            
            <div data-role="footer" data-theme="b" data-position="fixed">
                <fieldset class="full subbuttons" data-role="controlgroup" data-type="horizontal">
                    <button data-icon="delete">Eliminar Relaciones</button>
                </fieldset>
            </div>
        </div>
        
        
        
        <div data-role="page" id="configurations">
            <div data-role="header" data-position="fixed">
                <a href="#" data-rel="back" data-iconpos="notext" data-role="button" data-icon="arrow-l">Regresar</a>
                <h1>Horarios</h1>
            </div>
            
            <div data-role="content">
                <div data-role="tabs" id="tabs">
                    <div data-role="navbar" class="days">
                        <ul>
                            <li><a href="#L" data-ajax="false">L</a></li>
                            <li><a href="#M" data-ajax="false">M</a></li>
                            <li><a href="#X" data-ajax="false">M</a></li>
                            <li><a href="#J" data-ajax="false">J</a></li>
                            <li><a href="#V" data-ajax="false">V</a></li>
                            <li><a href="#S" data-ajax="false">S</a></li>
                            <li><a href="#D" data-ajax="false">D</a></li>
                        </ul>
                    </div>
                    
                    <div id="one" class="ui-body-d ui-content">
                        <div data-role="collapsible" data-theme="b" data-inset="false">
                            <h3>Suspend</h3>
                            <ul data-role="listview">
                                <li><a href="#">Canary</a></li>
                                <li><a href="#">Cat</a></li>
                                <li><a href="#">Dog</a></li>
                                <li><a href="#">Gerbil</a></li>
                                <li><a href="#">Iguana</a></li>
                                <li><a href="#">Mouse</a></li>
                            </ul>
                        </div><!-- /collapsible -->
                        <div data-role="collapsible" data-theme="b" data-inset="false">
                            <h3>Shut Down</h3>
                            <ul data-role="listview">
                                <li><a href="#">Chicken</a></li>
                                <li><a href="#">Cow</a></li>
                                <li><a href="#">Duck</a></li>
                                <li><a href="#">Horse</a></li>
                                <li><a href="#">Pig</a></li>
                                <li><a href="#">Sheep</a></li>
                            </ul>
                        </div><!-- /collapsible -->
                    </div>
                </div>
            </div>
            
            <div data-role="footer" data-theme="b" data-position="fixed">
                <fieldset class="full subbuttons" data-role="controlgroup" data-type="horizontal">
                    <button data-icon="delete">Cancelar</button>
                    <button data-icon="check">Aceptar</button>
                </fieldset>
            </div>
        </div>

        
        
        <div data-role="page" id="view-graphic">
            <div data-role="header" data-position="fixed">
                <a href="#" data-rel="back" data-iconpos="notext" data-role="button" data-icon="arrow-l">Regresar</a>
                <h1>Grafica</h1>
            </div>

            <div data-role="content">
                <div id="grafica"></div>
            </div>
        </div>
    </body>
</html>
